<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>{{ letter_subject }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* --- Page + Typography (print-authentic) --- */
  @page {
    size: letter;
    margin: 1in;
    @bottom-right {
      content: counter(page);
      font-family: "Times New Roman", serif;
      font-size: 12pt;
    }
  }

  html, body {
    background: #f5f5f5;
  }
  body {
    font-family: "Times New Roman", Times, serif;
    font-size: 12pt;
    line-height: 1.5;
    color: #000;
    margin: 0;
  }

  .document {
    max-width: 8.5in;
    margin: 0 auto;
    padding: 1in;
    background: white;
    border: 1px solid #d3d3d3;
    box-shadow: 3px 3px 20px rgba(0,0,0,0.1);
    overflow-wrap: break-word;
  }

  /* CSS counters for automatic paragraph numbering */
  body { counter-reset: para footnote; }
  p.numbered::before {
    counter-increment: para;
    content: counter(para) ". ";
    font-weight: bold;
  }

  /* Footnotes (endnotes) */
  sup.fn-ref { font-size: 0.7em; vertical-align: super; cursor: pointer; }
  sup.fn-ref::after { counter-increment: footnote; content: counter(footnote); }
  .footnotes { border-top: 1px solid #000; margin-top: 0.3in; padding-top: 0.15in; }
  .footnotes .fn-title { font-weight: bold; margin: 0.5em 0; text-decoration: none; text-align: left; }
  .footnotes ol { margin: 0.5em 0 0; padding-left: 1.2em; }
  .footnotes li { margin: 0.4em 0; }

  /* Lists inside content (do not affect main paragraph counter) */
  ul.disc { list-style: disc; padding-left: 1.5em; margin: 0.5em 0; }
  ol.alpha { list-style: lower-alpha; padding-left: 1.5em; margin: 0.5em 0; }
  ol.decimal { list-style: decimal; padding-left: 1.5em; margin: 0.5em 0; }

  /* Toolbar (ContentEditable interface) */
  .toolbar { position: sticky; top: 0; background: #fff; border: 1px solid #ddd; padding: 6px 8px; margin: -0.5in -0.5in 0.5in -0.5in; z-index: 10; }
  .toolbar button { font-size: 12pt; margin-right: 8px; }

  /* Editable region visual cue */
  .editable:focus { outline: 2px solid #cde7ff; }
  p.numbered:hover { background-color: #fffacd; }

  /* --- Letterhead --- */
  .letterhead {
    text-align: center;
    margin-bottom: 0.5in;
    padding-bottom: 0.2in;
    border-bottom: 2px solid #000;
  }
  
  .firm-name {
    font-size: 18pt;
    font-weight: bold;
    margin-bottom: 0.1in;
  }
  
  .firm-address {
    font-size: 11pt;
    line-height: 1.3;
  }
  
  .firm-contact {
    font-size: 11pt;
    margin-top: 0.1in;
  }

  /* --- Letter Header --- */
  .letter-header {
    margin: 0.4in 0;
  }
  
  .date-line {
    text-align: right;
    margin-bottom: 0.4in;
  }
  
  .recipient-block {
    margin-bottom: 0.3in;
  }
  
  .recipient-name {
    font-weight: bold;
  }
  
  .recipient-address {
    margin-top: 0.05in;
  }
  
  .reference-line {
    margin: 0.3in 0;
    font-weight: bold;
  }
  
  .subject-line {
    margin: 0.2in 0;
    font-weight: bold;
  }
  
  .salutation {
    margin-bottom: 0.2in;
  }

  /* --- Letter Body --- */
  .letter-body {
    margin: 0.3in 0;
  }
  
  p {
    margin: 0 0 0.2in;
    text-align: justify;
    line-height: 1.5;
  }
  
  .paragraph-indent {
    text-indent: 0.3in;
  }
  
  .numbered-paragraph {
    text-indent: -0.3in;
    padding-left: 0.3in;
    margin-bottom: 0.15in;
  }
  
  .paragraph-number {
    font-weight: bold;
  }
  
  .blockquote {
    margin: 0.2in 0.5in;
    padding-left: 0.2in;
    border-left: 2px solid #ccc;
    font-style: italic;
  }

  /* --- Lists --- */
  .letter-list {
    margin: 0.15in 0 0.15in 0.3in;
  }
  
  .letter-list li {
    margin-bottom: 0.1in;
    text-align: justify;
  }

  /* --- Legal formatting --- */
  .statute {
    font-weight: bold;
  }
  
  .case-cite {
    font-style: italic;
  }
  
  .emphasis {
    font-weight: bold;
  }
  
  .important {
    font-weight: bold;
    text-transform: uppercase;
  }
  
  .deadline {
    font-weight: bold;
    text-decoration: underline;
  }

  /* --- Closing --- */
  .letter-closing {
    margin-top: 0.4in;
  }
  
  .closing-phrase {
    margin-bottom: 0.6in;
  }
  
  .signature-block {
    margin-bottom: 0.3in;
  }
  
  .signature-line {
    width: 3in;
    border-top: 1px solid #000;
    margin-bottom: 0.1in;
  }
  
  .signature-name {
    font-weight: bold;
  }
  
  .signature-title {
    margin-top: 0.05in;
  }

  /* --- Enclosures and CC --- */
  .letter-footer {
    margin-top: 0.3in;
  }
  
  .enclosures,
  .cc-list {
    margin-top: 0.2in;
  }
  
  .enclosures-label,
  .cc-label {
    font-weight: bold;
  }

  /* --- Demand Letter Styling --- */
  .demand-notice {
    background-color: #fff3cd;
    border: 2px solid #856404;
    padding: 0.2in;
    margin: 0.3in 0;
    text-align: center;
  }
  
  .demand-header {
    font-weight: bold;
    text-transform: uppercase;
    font-size: 14pt;
    color: #856404;
  }

  /* --- Settlement Offer Styling --- */
  .settlement-offer {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    padding: 0.2in;
    margin: 0.3in 0;
  }
  
  .offer-amount {
    font-weight: bold;
    font-size: 14pt;
    text-align: center;
  }

  /* --- Footer page numbering for print --- */
  @media print {
    body {
      counter-reset: page;
    }
    .footer {
      position: fixed;
      bottom: 0.5in;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 10pt;
    }
    .footer:after {
      content: "Page " counter(page);
    }
    .document {
      padding: 0;
      margin: 0;
      max-width: none;
      border: none;
      box-shadow: none;
    }
    .toolbar { display: none; }
    p.numbered:hover { background: none; }
  }

  /* --- Screen-only footer preview --- */
  @media screen {
    .footer {
      display: none;
    }
  }

  /* --- Page break utility --- */
  .page-break {
    page-break-before: always;
    break-before: page;
  }
  
  /* --- Table styling --- */
  .letter-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.2in 0;
  }
  
  .letter-table th,
  .letter-table td {
    border: 1px solid #000;
    padding: 0.1in;
    text-align: left;
    vertical-align: top;
  }
  
  .letter-table th {
    font-weight: bold;
    background-color: #f5f5f5;
  }
</style>
</head>
<body>
  <div class="page">
    <!-- Toolbar for ContentEditable interface -->
    <div class="toolbar" aria-label="Editing toolbar">
      <button type="button" onclick="document.execCommand('bold')">Bold</button>
      <button type="button" onclick="document.execCommand('italic')">Italic</button>
      <button type="button" onclick="document.execCommand('insertUnorderedList')">Bulleted list</button>
      <button type="button" onclick="document.execCommand('insertOrderedList')">Numbered list</button>
      <button type="button" onclick="insertFootnote()">Insert footnote</button>
      <button type="button" onclick="clearFormatting()">Clear formatting</button>
    </div>

    <!-- Editable Content Region -->
    <div id="editable" class="editable" contenteditable="true">
      <!-- Letterhead -->
      {% if letterhead %}
      <div class="letterhead">
        <div class="firm-name">{{ letterhead.firm_name }}</div>
        {% if letterhead.address %}
        <div class="firm-address">{{ letterhead.address | replace('\n', '<br/>') | safe }}</div>
        {% endif %}
        <div class="firm-contact">
          {% if letterhead.phone %}Phone: {{ letterhead.phone }}{% endif %}
          {% if letterhead.phone and letterhead.email %} • {% endif %}
          {% if letterhead.email %}Email: {{ letterhead.email }}{% endif %}
          {% if letterhead.website %} • {{ letterhead.website }}{% endif %}
        </div>
      </div>
      {% endif %}

    <!-- Letter Header -->
    <div class="letter-header">
      <div class="date-line">{{ letter_date }}</div>
      
      {% if recipient %}
      <div class="recipient-block">
        <div class="recipient-name">{{ recipient.name }}</div>
        {% if recipient.title %}
        <div>{{ recipient.title }}</div>
        {% endif %}
        {% if recipient.company %}
        <div>{{ recipient.company }}</div>
        {% endif %}
        {% if recipient.address %}
        <div class="recipient-address">{{ recipient.address | replace('\n', '<br/>') | safe }}</div>
        {% endif %}
      </div>
      {% endif %}
      
      {% if reference_number %}
      <div class="reference-line">Re: {{ reference_number }}</div>
      {% endif %}
      
      {% if letter_subject %}
      <div class="subject-line">Subject: {{ letter_subject }}</div>
      {% endif %}
      
      <div class="salutation">{{ salutation | default('Dear Sir or Madam:') }}</div>
    </div>

    <!-- Special Notice Boxes -->
    {% if letter_type == 'demand' %}
    <div class="demand-notice">
      <div class="demand-header">Demand for Payment</div>
    </div>
    {% endif %}
    
    {% if settlement_offer %}
    <div class="settlement-offer">
      <div class="offer-amount">Settlement Offer: ${{ settlement_offer.amount }}</div>
      {% if settlement_offer.deadline %}
      <div style="text-align: center; margin-top: 0.1in;">
        <strong>Expires: {{ settlement_offer.deadline }}</strong>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Letter Body -->
    <div class="letter-body">
      {% for section in letter_sections %}
      <div class="letter-section">
        {% if section.title %}
        <p><strong>{{ section.title }}</strong></p>
        {% endif %}
        
        {% for paragraph in section.paragraphs %}
        {% if paragraph.numbered %}
        <p class="numbered-paragraph">
          <span class="paragraph-number">{{ paragraph.number }}.</span> {{ paragraph.content | safe }}
        </p>
        {% else %}
        <p{% if paragraph.indent %} class="paragraph-indent"{% endif %}>{{ paragraph.content | safe }}</p>
        {% endif %}
        {% endfor %}
        
        {% if section.list_items %}
        <ul class="letter-list">
          {% for item in section.list_items %}
          <li>{{ item | safe }}</li>
          {% endfor %}
        </ul>
        {% endif %}
        
        {% if section.blockquote %}
        <div class="blockquote">
          {{ section.blockquote | safe }}
        </div>
        {% endif %}
        
        {% if section.table %}
        <table class="letter-table">
          {% if section.table.headers %}
          <thead>
            <tr>
              {% for header in section.table.headers %}
              <th>{{ header }}</th>
              {% endfor %}
            </tr>
          </thead>
          {% endif %}
          <tbody>
            {% for row in section.table.rows %}
            <tr>
              {% for cell in row %}
              <td>{{ cell | safe }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- Letter Closing -->
    <div class="letter-closing">
      <div class="closing-phrase">{{ closing_phrase | default('Sincerely,') }}</div>
      
      <div class="signature-block">
        <div class="signature-line"></div>
        <div class="signature-name">{{ sender.name }}</div>
        {% if sender.title %}
        <div class="signature-title">{{ sender.title }}</div>
        {% endif %}
        {% if sender.firm %}
        <div class="signature-title">{{ sender.firm }}</div>
        {% endif %}
        {% if sender.bar_number %}
        <div class="signature-title">State Bar No. {{ sender.bar_number }}</div>
        {% endif %}
      </div>
    </div>

    <!-- Letter Footer -->
    <div class="letter-footer">
      {% if enclosures %}
      <div class="enclosures">
        <span class="enclosures-label">Enclosures:</span>
        {% for enclosure in enclosures %}
        <div style="margin-left: 0.5in;">{{ enclosure }}</div>
        {% endfor %}
      </div>
      {% endif %}

      {% if cc_list %}
      <div class="cc-list">
        <span class="cc-label">cc:</span>
        {% for cc in cc_list %}
        <div style="margin-left: 0.3in;">{{ cc }}</div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Endnotes Section -->
    <div id="endnotes" class="footnotes">
      <div class="fn-title">FOOTNOTES</div>
      <ol id="footnotes-list" contenteditable="true"></ol>
    </div>
  </div>
  </div>

  <div class="footer"></div>

<script>
  // Paste sanitation: force plain text to preserve margins/format
  const editable = document.getElementById('editable');
  if (editable) {
    editable.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text/plain');
      document.execCommand('insertText', false, text);
    });

    // Ensure new paragraphs are auto-numbered (outside of lists)
    const observer = new MutationObserver((mutations) => {
      for (const m of mutations) {
        m.addedNodes && m.addedNodes.forEach((node) => {
          if (node.nodeType !== 1) return; // element only
          if (node.closest && node.closest('ol, ul')) return; // lists excluded

          // Convert stray DIVs to P.numbered for consistent numbering
          if (node.tagName === 'DIV') {
            const p = document.createElement('p');
            p.className = 'numbered';
            p.innerHTML = node.innerHTML;
            node.replaceWith(p);
          }
          // Add numbering class to plain <p>
          if (node.tagName === 'P' && !node.classList.contains('numbered')) {
            node.classList.add('numbered');
          }
        });
      }
    });
    observer.observe(editable, { childList: true, subtree: true });
  }

  // Clear formatting helper (keeps plain text and numbering class)
  function clearFormatting() {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    const text = range.toString();
    if (!text) return;
    document.execCommand('insertText', false, text);
  }

  // Footnotes logic (endnotes with auto-renumbering)
  const footnotesListEl = document.getElementById('footnotes-list');

  function insertFootnote() {
    const text = prompt('Footnote text:');
    if (text === null) return;
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    // Insert an empty reference; number is provided by CSS counter
    const sup = document.createElement('sup');
    sup.className = 'fn-ref';
    sup.setAttribute('data-fnid', '');
    range.insertNode(sup);
    // Move caret after the inserted ref
    range.setStartAfter(sup);
    range.setEndAfter(sup);
    sel.removeAllRanges();
    sel.addRange(range);

    reindexFootnotes();

    // Set initial text on the corresponding endnote item
    const refs = Array.from(document.querySelectorAll('#editable sup.fn-ref'));
    const idx = refs.indexOf(sup);
    const id = String(idx + 1);
    const li = document.querySelector('#footnotes-list li[data-fnid="' + id + '"]');
    if (li && (!li.textContent || li.textContent.startsWith('Footnote '))) {
      li.textContent = text;
    }
  }

  function reindexFootnotes() {
    const list = document.getElementById('footnotes-list');
    if (!list) return;
    const refs = Array.from(document.querySelectorAll('#editable sup.fn-ref'));
    const existing = new Map(Array.from(list.children).map(li => [li.getAttribute('data-fnid'), li]));
    const frag = document.createDocumentFragment();

    refs.forEach((ref, i) => {
      const oldId = ref.getAttribute('data-fnid') || '';
      const newId = String(i + 1);
      ref.setAttribute('data-fnid', newId);
      let li = existing.get(oldId) || existing.get(newId);
      if (!li) {
        li = document.createElement('li');
        li.contentEditable = 'true';
        li.setAttribute('data-fnid', newId);
        li.textContent = 'Footnote ' + newId;
      } else {
        li.setAttribute('data-fnid', newId);
      }
      frag.appendChild(li);
    });

    list.innerHTML = '';
    list.appendChild(frag);
  }

  // Reindex on edits (debounced)
  let fnTimer;
  if (editable) {
    editable.addEventListener('input', () => {
      clearTimeout(fnTimer);
      fnTimer = setTimeout(reindexFootnotes, 300);
    });

    // Click-through navigation
    editable.addEventListener('click', (e) => {
      const ref = e.target.closest && e.target.closest('sup.fn-ref');
      if (!ref) return;
      const id = ref.getAttribute('data-fnid');
      const li = document.querySelector('#footnotes-list li[data-fnid="' + id + '"]');
      if (li) li.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
  }

  if (footnotesListEl) {
    footnotesListEl.addEventListener('click', (e) => {
      const li = e.target.closest && e.target.closest('li[data-fnid]');
      if (!li) return;
      const id = li.getAttribute('data-fnid');
      const ref = document.querySelector('#editable sup.fn-ref[data-fnid="' + id + '"]');
      if (ref) ref.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    // Initialize footnotes on load
    reindexFootnotes();
  }
</script>

</body>
</html>
