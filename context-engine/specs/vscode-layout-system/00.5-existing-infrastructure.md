# VS Code Layout System - Existing Infrastructure Analysis

## Overview
This document maps the existing codebase to identify what can be REUSED, what must be EXTENDED, and what is NET NEW.

---

## 1. Layout Architecture (EXTEND)

### `src/renderer/layout.tsx`
**Current Behavior:**
- Renders main app layout with left sidebar (250px) and content area
- Sidebar contains `Sider` component (conversation history + settings)
- Conditionally hides sidebar on `/cases` page
- Manages collapsed state for mobile

**Changes Required:**
- Replace `Sider` with new `IconSidebar` (48px)
- Add `LeftPanel` container between sidebar and content
- Update width calculations to account for panel state

**Reuse:** Layout structure, mobile detection, LayoutContext
**Extend:** Add panel state management, update width logic
**Net New:** IconSidebar integration

---

## 2. Conversation Layout (EXTEND)

### `src/renderer/pages/conversation/ChatLayout.tsx`
**Current Behavior:**
- Two-column layout: Workspace (left) + Chat (right)
- Workspace is draggable (200-500px)
- Toggle button to collapse workspace
- Header with conversation title and backend logo

**Changes Required:**
- Remove workspace from this component (move to LeftPanel)
- Chat becomes full-width when panel closed
- Chat resizes dynamically when panel opens
- Keep header structure but update toggle button behavior

**Reuse:** Header, drag logic (adapt for new divider), mobile detection
**Extend:** Width calculations, toggle behavior
**Net New:** Integration with panel system

---

## 3. Sidebar Components (REPLACE)

### `src/renderer/sider.tsx`
**Current Behavior:**
- Shows "New Chat" button
- Renders `ChatHistory` component
- Settings button
- User management (admin only)
- Logout button
- Returns `null` on `/cases` page

**Changes Required:**
- REPLACE entirely with `IconSidebar`
- Move conversation history to `ConversationPanel`
- Convert buttons to icons (üí¨, üìÅ, üìÑ, ‚öôÔ∏è, üë§)

**Reuse:** Navigation logic, auth checks
**Extend:** None (full replacement)
**Net New:** IconSidebar component

### `src/renderer/pages/conversation/ChatHistory.tsx`
**Current Behavior:**
- Lists conversations for current case
- Filters by `caseFileId` param
- Edit/delete conversation actions
- Scroll-to-view for active conversation
- Empty state when no conversations

**Changes Required:**
- Wrap in `ConversationPanel` component
- No internal changes needed

**Reuse:** ENTIRE COMPONENT (100%)
**Extend:** None
**Net New:** Panel wrapper only

---

## 4. Workspace Components (REUSE)

### `src/renderer/pages/conversation/ChatWorkspace.tsx`
**Current Behavior:**
- File tree using Arco Design Tree
- Search, refresh, create folder/file
- Context menu (open, rename, delete, paste)
- Double-click opens file externally OR in preview modal
- Filters excluded files (AGENTS.md, WARP.md, etc.)

**Changes Required:**
- Wrap in `WorkspacePanel` component
- Update double-click to open in `FilePreviewPanel` instead of modal
- Keep all other functionality

**Reuse:** ENTIRE COMPONENT (95%)
**Extend:** Double-click handler to integrate with panel system
**Net New:** Panel wrapper only

### `src/renderer/pages/conversation/ChatSider.tsx`
**Current Behavior:**
- Conditionally renders `ChatWorkspace` based on conversation type
- Returns empty div if no workspace

**Changes Required:**
- REMOVE (workspace now in LeftPanel system)

**Reuse:** None
**Extend:** None
**Net New:** Replaced by panel system

---

## 5. File Preview (REUSE)

### `src/renderer/components/WorkspaceFilePreview/index.tsx`
**Current Behavior:**
- Modal that displays markdown/HTML/text files
- Loads file content via IPC
- "Open in External Editor" button
- Loading and error states

**Changes Required:**
- Convert from modal to panel component
- Add tab bar at top (for future multi-file support)
- Add "back to workspace" button
- Remove modal wrapper

**Reuse:** File loading logic, rendering logic (90%)
**Extend:** UI structure (modal ‚Üí panel)
**Net New:** Tab bar, navigation controls

---

## 6. State Management (NET NEW)

### Current State Locations
| State | Component | Scope |
|-------|-----------|-------|
| `siderCollapsed` | `Layout` | Global (left sidebar) |
| `rightSiderCollapsed` | `ChatLayout` | Local (workspace panel) |
| `filePreview` | `ChatWorkspace` | Local (modal state) |

### New State Requirements
| State | Location | Purpose |
|-------|----------|---------|
| `activePanelId` | Context/Hook | Which panel is open ('conversations', 'explorer', 'preview', null) |
| `leftPanelWidth` | Context/Hook | Width of left panel (200-600px) |
| `openFileTab` | Context/Hook | Currently open file in preview panel |

**Recommendation:** Create `usePanelState` hook or PanelContext

---

## 7. Drag & Resize Logic (ADAPT)

### `src/renderer/pages/conversation/ChatLayout.tsx` - `useSiderWidthWithDrag`
**Current Implementation:**
- Drag handle on right edge of workspace
- Mouse events for drag start/move/end
- Width constraints (200-500px)
- Double-click to reset
- Visual feedback during drag

**Changes Required:**
- Move to shared hook/component
- Update to work with LeftPanel instead of Sider
- Adjust constraints (200-600px)
- Ensure chat maintains 400px minimum

**Reuse:** Core drag logic (80%)
**Extend:** Width calculation to respect chat minimum
**Net New:** Shared implementation

---

## 8. Routing & Navigation (NO CHANGE)

### `src/renderer/router.tsx`
**Current Routes:**
- `/cases` - Case selection
- `/:caseFileId/guid` - New conversation
- `/:caseFileId/conversation/:id` - Conversation view
- `/settings/*` - Settings pages

**Changes Required:** NONE

**Reuse:** 100%

---

## 9. Mobile Responsiveness (EXTEND)

### Current Mobile Behavior
- Sidebar collapses to 0px on mobile (< 768px)
- Workspace auto-collapses on mobile
- Click outside to close panels

**Changes Required:**
- LeftPanel becomes full-screen overlay on mobile
- IconSidebar becomes hamburger menu
- Tap outside panel to close

**Reuse:** Mobile detection logic, collapse behavior
**Extend:** Panel overlay behavior
**Net New:** Full-screen panel mode

---

## 10. Summary: Reuse vs. Extend vs. Net New

### REUSE (No Changes)
- ‚úÖ `ChatHistory` component (wrap only)
- ‚úÖ `ChatWorkspace` component (minor handler update)
- ‚úÖ File loading logic in `WorkspaceFilePreview`
- ‚úÖ Routing system
- ‚úÖ Authentication/authorization

### EXTEND (Modify Existing)
- üîß `Layout` - Add panel system
- üîß `ChatLayout` - Remove workspace, add dynamic sizing
- üîß `WorkspaceFilePreview` - Convert modal to panel
- üîß `useSiderWidthWithDrag` - Adapt for new layout
- üîß Mobile responsiveness - Add overlay mode

### NET NEW (Create from Scratch)
- ‚≠ê `IconSidebar` component
- ‚≠ê `LeftPanel` container component
- ‚≠ê `ConversationPanel` wrapper
- ‚≠ê `WorkspacePanel` wrapper
- ‚≠ê `FilePreviewPanel` component
- ‚≠ê `usePanelState` hook
- ‚≠ê Panel transition animations

---

## 11. Risk Mitigation

### Potential Conflicts
1. **Z-index issues:** New panels might conflict with existing modals
   - **Solution:** Use consistent z-index scale (sidebar: 100, panel: 90, modals: 1000)

2. **Drag conflicts:** Workspace drag-and-drop vs. divider drag
   - **Solution:** Use different mouse button or modifier key detection

3. **State synchronization:** Panel state vs. existing collapsed states
   - **Solution:** Migrate to unified state management (Context or Zustand)

4. **Performance:** Animations on low-end devices
   - **Solution:** Use CSS transforms (GPU-accelerated), add prefers-reduced-motion

---

**Next Step:** Proceed to Architecture phase (01-implementation-plan.md)

